function gallery(wrapper) {
	
	console.log("gallery.js: Called.");

	resetdom();
	
	$(window).unbind('hashchange.gallery');
	$(window).bind( 'hashchange.gallery',function() {
		console.log('gallery.js: Hash has changed to ' + location.hash);
		gallery(wrapper);
	});

	var GALLERIES = cataloginfo();

	if (GALLERIES === "") {
		console.log("gallery.js: Call to cataloginfo() failed.");
		$(wrapper + " #workingfullframe").hide();
		return;
	}

	if (location.hash != "") {
		var hash = location.hash;
		console.log("gallery.js: Hash is not empty.  Updating catalog if hash was URL.")
		var galleryid = hash.replace(/^#/,'').replace(/^\//,"");
		cataloginfo(galleryid); 	// Updates catalog to include one auto-generated by URL.
		GALLERIES = cataloginfo();  // Get list with new URL.
	} else {
		// Default gallery to show is first in list.
		var galleryid = GALLERIES["Values"][0]["Id"];
	}
	VIVIZ[galleryid] = {};

	var GALLERYINFO = galleryinfo(galleryid);

	// If call to GALLERYINFO fails, something went wrong.
	if (typeof(GALLERYINFO) === "boolean") {
		console.log("gallery.js: Call to galleryinfo() failed.");	
		$(wrapper + ' #workingfullframe').css('visibility','hidden');
		error(wrapper,"Problem with gallery configuration.");
		//$(wrapper + ' #catalogxmlopen').click();
		return;
	}

	setheader();
	setdropdowns();
	setthumbs();

	if (typeof(tooltip) === "function") {
	    $(wrapper + " button").each(function () {$(this).tooltip({content: $(this).attr('title')})});
	    $(wrapper + " select").each(function () {$(this).tooltip({content: $(this).attr('title')})});
	}

	function resetdom() {
		$(wrapper + " #fullframe").html('').css('height','');
		$(wrapper).css('margin-top','0');
		$(wrapper + " #gallerythumbframe").html('');
		$(wrapper).attr('nowvisible', '').attr('lastvisible', '').attr('totalvisible', '').attr('totalingallery', '');
		$(wrapper + " #stats").html('').css('width','').css('height','');
		$(wrapper + " #error").html('').hide();
		$(wrapper + " #warning").html('').hide();
		$(wrapper + " #connectionerror").html('');
		$(wrapper + " #catalogxml").html('');
		$(wrapper + " #gallerythumbframe").css('width','').css('height','');
	}

	function setheader() {

	    if (typeof(tooltip) === "function") {
		$(wrapper + " button").each(function () {$(this).tooltip({content: $(this).attr('title')})});
		$(" select").each(function () {$(this).tooltip({content: $(this).attr('title')})});
	    }
		var HEADER = cataloginfo(galleryid);

		if (HEADER === "") {
			error(wrapper,"Gallery ID " + galleryid + " not found. Redirecting in 5 seconds.");
			console.log("Gallery ID " + galleryid + " not found. Redirecting in 5 seconds.");
			//alert("Gallery ID " + galleryid + " not found. Redirecting in 5 seconds.")
			$(wrapper + ' #workingfullframe').css('visibility','hidden');
			setTimeout(function () {window.location = "/";$(wrapper + ' #error').hide();},5000);
			return;
		}

		if (VIVIZ["showAboutText"]) {
			$(wrapper + " #abouttextwrapper").show();
		}
		
		$("head title").html(HEADER["title"]+ ": " + HEADER["about"]);
		$(wrapper + " #about").attr('title',HEADER["about"]);
		if (HEADER["about"].length > 0) {
			if (HEADER["about"].match("auto-generated")) {
				$(wrapper + " #abouttext").html(HEADER["about"].replace("URL","<a style='text-decoration:underline' href='/#"+HEADER["title"]+"'>URL</a>"));
			} else {
			$(wrapper + " #abouttext").html(HEADER["title"]+ ": " + HEADER["about"]);
			}

		} else {
			$(wrapper + " #abouttextwrapper").hide();
		}

		//$(wrapper + " button).

		if ((HEADER["aboutlink"].length > 0) && (HEADER["about"].length == 0)) {
			$(wrapper + " #aboutbuttonwrapper").attr("onclick","window.location='" + HEADER["aboutlink"]+"'");
		}	
		if ((!HEADER["aboutlink"]) && (HEADER["about"])) {
			//$(wrapper + " #about").attr("onclick","window.location='" + HEADER["Fulldir"]+"'");
			$(wrapper + " #aboutbuttonwrapper").show();
			if (HEADER["about"].match(/^http/)) {
				//$(wrapper + " #about").html('<a style="color:white"	>About this gallery</a>');
				$(wrapper + " #aboutbuttonwrapper").attr('onclick',"window.location='" + HEADER["about"] + "'");
				$(wrapper + " #aboutbuttonwrapper").attr("title","Go to page with information about these images:\n"+HEADER["about"])
				    if (typeof(tooltip) === "function") {
					$(wrapper + " #aboutbuttonwrapper").tooltip({content: "Go to page with information about these images:\n"+HEADER["about"]});
				    }
			} else {
				$(wrapper + " #aboutbuttonwrapper").attr('title',HEADER["about"] + ". Click to show or hide title line.");
				// Set click to show or hide about text.
				$(wrapper + " #aboutbuttonwrapper").on("click",
					function () {
						if ($(wrapper + " #abouttextwrapper").is(":visible")) {
							$(wrapper + " #abouttextwrapper").hide(); 
						} else {
							$(wrapper + " #abouttextwrapper").show(); 
						}
					});
			}
		}

		if (!VIVIZ["showFileName"]) $(wrapper + " #filename").hide();

		if (VIVIZ["showCatalog"] && typeof(CodeMirror) !== "undefined") {
			$(wrapper + ' #catalogxmlopen').show();
			$(wrapper + ' #catalogxmlclose').hide();
			$(wrapper + " #catalogxmlopen").unbind('click');
			$(wrapper + " #catalogxmlopen").click(
					function () {
						CodeMirror($(wrapper+' #catalogxml')[0], {lineNumbers:true,"mode":"xml", "value":HEADER["xml"]});
						$(wrapper + ' #catalogxmlopen').hide();
						$(wrapper + ' #catalogxmlclose').show();
					});
			$(wrapper + " #catalogxmlclose").unbind('click');
			$(wrapper + " #catalogxmlclose").click(
					function () {
						$(wrapper + " #catalogxml").html('');
						$(wrapper + ' #catalogxmlopen').show();
						$(wrapper + ' #catalogxmlclose').hide();
					}
				);

			if (!VIVIZ["showCatalog"]) $(wrapper + " #catalog").hide();
			if (!VIVIZ["showControls"]) $(wrapper + " #controls").hide()
			if (!VIVIZ["showAttributes"]) $(wrapper + " #attributes").hide()
			if (!VIVIZ["showDropdowns"]) $(wrapper + " #dropdowns").hide()
		} else {
			if (VIVIZ["showCatalog"]) {
				console.log("gallery.setheader(): showCatalog set to true, but codemirror is not available.")
			}
			$(wrapper + ' #catalog').hide();
		}
	}

	function setthumbs() {
	
		console.log('gallery.setthumbs(): Setting thumbs.');
		
		INFOjs = thumblist(wrapper);  // Global variable.

		// Set attributes used by lazy loader
		$(wrapper).attr('totalvisible', INFOjs.length);
		$(wrapper).attr('totalingallery',GALLERYINFO["totalingallery"]);

		var thumbframe = $(wrapper + ' #gallerythumbframe');

		$(wrapper + " #fullframe").html('')
		thumbframe.html(''); // Clear thumbframe
		
		// Clear any previous scroll binding.  (Lazy load uses this.)
		thumbframe.unbind('scroll');

		$(wrapper + ' #stats').html('');
		if (INFOjs.length == 0) {
			$(wrapper + ' #stats').html('No images in subset.');
			return;
		}
		
		s = setthumb(INFOjs,0,true);
	}
	
	function setthumb(INFOjs,i,allbad) {

		var firstclicked = false;
		if (i == 0) firstimage(i); 

		// TODO: Detect bad images:
		// https://github.com/desandro/imagesloaded
		// http://stackoverflow.com/questions/821516/browser-independent-way-to-detect-when-image-has-been-loaded
		// http://stackoverflow.com/questions/3877027/jquery-callback-on-image-load-even-when-the-image-is-cached

		function firstimage(f) {

			console.log("gallery.firstimage(): Called.");
			if (f == 0) setcontrolbindings();
			
			$('<img class="gallerythumbbrowse firstimage"/>')
				.appendTo($(wrapper + ' #gallerythumbframe'))
				.attr("id",f+1)
				.error(function () {
					// First image is bad.
					console.log("gallery.firstimage(): Image " + f + " is bad.");
					//warning("Image " + f + " not found.",true);
					$(this).remove();

					if (f > 0) {
						if (f == 1) {
							warning(wrapper,"The first image could not be loaded.",true,Infinity);
						} else {
							warning(wrapper,"Image " + f + " could not be loaded.",true,Infinity);
						}
					}
					
					if (f == INFOjs.length-1) {
						warning(wrapper,"No images could be loaded.",true,Infinity);
						console.log("No images could be loaded.");
						$(wrapper + " #workingfullframe").css('visibility','hidden');
						return;
					}
					//findfirstimage(f+1,allbad);
					firstimage(f+1,allbad);
				})
				//.bind('click',setthumbbindings)
				.attr("src", INFOjs[f].ThumbFile)
				.load(function () {
					
					if (f > 0) {
						if (f == 1) {
							warning(wrapper,"The first image in this subset could not be loaded.",true);
						} else {
							warning(wrapper,"The first " + f + " images" + " in this subset could not be loaded.",true);
						}
					}
					
					// Trigger load of the first image.
					if (!firstclicked) {
						console.log("gallery.firstimage(): Clicking first image.");
						$(wrapper).attr('nowvisible',f+1)
						$(this).bind('click',setthumbbindings).click();
					}
					firstclicked = true;

					// Scroll to top.
					$(wrapper + " #gallerythumbframe").scrollTo(0);

					// Set title attribute on thumbnail
					//$(this).attr("title",imgtitle(INFOjs[f]));

						type = 'thumb'
						el = this;

						var tmp = setWH(this,galleryid,GALLERYINFO);

					// Set height of thumbnail image.
					$(this).css("height",VIVIZ[galleryid]["thumbHeight"]);
					$(this).css("width",VIVIZ[galleryid]["thumbWidth"]);


					console.log('gallery.firstimage(): First thumbnail loaded with natural dimensions = '+this.naturalWidth+'x'+this.naturalHeight+ '.');
					console.log('gallery.firstimage(): First thumbnail set to have dimensions = '+VIVIZ[galleryid]["thumbWidth"]+'x'+VIVIZ[galleryid]["thumbHeight"]+ '.');

					//settabledims();
					
					// Lazy Load images.
					$('#gallerythumbframe').attr('data-thumb-length', INFOjs.length);
					var maxLength = INFOjs.length;
					if (INFOjs.length > VIVIZ["lazyLoadMax"]) {
						maxLength = VIVIZ["lazyLoadMax"];
					}
					if (maxLength + f > INFOjs.length) {
						maxLength = INFOjs.length-f;
					}

					// Set attribute that indicates which thumbnail is active.
					$('#gallerythumbframe').attr('data-thumb-displayed', f);
					
					setscrollbinding();

					// Set next batch of thumbnails.
					var tic = new Date().getTime();
					var slowwarn = false;
					console.log("gallery.firstimage(): Setting thumbnails "+(f+1)+"-"+(f+maxLength-1));
					for (var j = f+1; j < f+maxLength; j++) {
						if ($(wrapper + " #"+(j+1)).length == 0) { // Was not already loaded by findfirstimage
							$('<img class="gallerythumbbrowse"/>')
								.appendTo($(wrapper + ' #gallerythumbframe'))
								.attr("id",j+1)
								.attr("src", INFOjs[j].ThumbFile)
								.bind('click',setthumbbindings)
								.attr("title",imgtitle(INFOjs[j]))
								.css("height",VIVIZ[galleryid]["thumbHeight"])
								.css("width",VIVIZ[galleryid]["thumbWidth"])
								.load(function () {
									if ((slowwarn == false) && (new Date().getTime() - tic > 3000)) {
										warning(wrapper,"Slow-loading gallery.  See <a href='http://viviz.org/#Performace'>performace tips</a> for improving performance.");
										slowwarn = true;	
									}	
								});
						}
					}
			});     
		}

		function setscrollbinding() {

			console.log("gallery.setscrollbinding: Called.");

			$('#gallerythumbframe').scroll(function(e){
				console.log("gallery.setscrollbinding(): Scroll event.")
				var elem = $(this);
				console.log("scrollHeight: " + elem[0].scrollHeight);
				console.log("scrollHeight: " + elem[0].scrollTop);
				console.log("scrollHeight: " + elem[0].clientHeight);
				//console.log(elem[0].scrollHeight - elem[0].scrollTop - elem[0].clientHeight)
				if (elem[0].scrollHeight - elem[0].scrollTop - elem[0].clientHeight <= 0) {
					console.log("Calling loadmore().")
					loadmore();
				}
			});
		}
	}

	function settabledims(el,callback) {

		console.log("gallery.settabledims(): Called.")
		console.log("gallery.settabledims(): Full img natural width = " + VIVIZ[galleryid]["fullNaturalWidth"]);
		console.log("gallery.settabledims(): Full img natural height = " + VIVIZ[galleryid]["fullNaturalHeight"]);
		console.log("gallery.settabledims(): Full img scaled width = " + VIVIZ[galleryid]["fullWidth"]);
		console.log("gallery.settabledims(): Full img scaled height = " + VIVIZ[galleryid]["fullHeight"]);
		
		//if (galleryid.match(/ACE/)) {return;}

		if (el) {
			// Don't get border-width by querying DOM for first thumbnail, because it may not be in 
			// DOM already.  Instead, get it from function parameter.
			var bw = 2*parseFloat($(el).css('border-width').replace("px",''));
			if (isNaN(bw)) {
				bw = $(wrapper + ' #gallerythumbframe img:first').outerWidth() - VIVIZ[galleryid]["thumbWidth"];
			}
			if  (isNaN(bw)) {
				bw = 2;
			}
			var w = VIVIZ[galleryid]["thumbWidth"] + $.scrollbarWidth() + bw + 8; // Why 8?
			console.log("gallery.firstimage(): Setting #gallerythumbframe width to = "+w);
			$(wrapper + ' #gallerythumbframe').width(w);
		}

		// Set heights of thumbframe and fullframe. When first image is loaded, fullNaturalHeight is set.
		if (VIVIZ[galleryid]["fullHeight"] > 0) {
			
			// Aspect ratio;
			var ar = VIVIZ[galleryid]["fullWidth"]/VIVIZ[galleryid]["fullHeight"];
			console.log("gallery.settabledims(): Aspect ratio = "+ar);

			// Force outer frame to stay the same size after image is removed and before new image is inserted.
			//$(wrapper + " #fullframe").width($(wrapper + " #fullframe").width())
			
			// Set height of thumb strip to be full height of image.
			$(wrapper + ' #gallerythumbframe').height(VIVIZ[galleryid]["fullHeight"]);
			//return;
			enclosure = $(wrapper).parents().filter('body')[0];
			enclosure = "body";
			console.log("gallery.settabledims(): Window height: "+ $(window).height());
			console.log("gallery.settabledims(): Client height: "+ document.documentElement.clientHeight);
			console.log("gallery.settabledims(): Document height: "+ $(document).height());
			console.log("gallery.settabledims(): Enclosing body height: " + $(enclosure).height());
			// Amount height needs to shrink so that no scrollbar appears.
			dh = $(enclosure).height() - $(window).height();
			console.log("gallery.settabledims(): dh = "+dh);

			if (dh > 0) {
				console.log("gallery.settabledims(): Shrinking height of #fullframe img.")
				$(wrapper + ' #fullframe img').height(VIVIZ[galleryid]["fullHeight"]-dh)
				console.log("gallery.settabledims(): Shrinking height of #gallerythumbframe to "+(VIVIZ[galleryid]["fullHeight"]-dh));
				$(wrapper + ' #gallerythumbframe').height(VIVIZ[galleryid]["fullHeight"]-dh);
				VIVIZ[galleryid]['fullHeight'] = VIVIZ[galleryid]["fullHeight"]-dh;
				VIVIZ[galleryid]['fullWidth']  = $(wrapper + ' #gallerythumbframe img:first').width()	        	
			} else {
				console.log("gallery.settabledims(): Full image height known and dh <= 0.  Setting #gallerythumbframe height to be height of full image = " + VIVIZ[galleryid]["fullHeight"] + ".");
				console.log("gallery.settabledims(): Setting #gallerythumbframe height to "+VIVIZ[galleryid]["fullHeight"])
				$(wrapper + " #gallerythumbframe").height(VIVIZ[galleryid]["fullHeight"]);
			}

			console.log("gallery.settabledims(): Window height: "+ $(window).height());
			console.log("gallery.settabledims(): Client height: "+ document.documentElement.clientHeight);
			console.log("gallery.settabledims(): Document height: "+ $(document).height());
			console.log("gallery.settabledims(): Enclosing body height: " + $(enclosure).height());

			console.log("gallery.settabledims(): Window width: "+ $(window).width());
			console.log("gallery.settabledims(): Document width: "+ $(document).width());
			console.log("gallery.settabledims(): Enclosing body width: " + $(enclosure).width());

			dw = $(document).width()-$(enclosure).width();
			console.log("gallery.settabledims(): dw = "+dw);
			//return

			if (dw > 0) {
				if (dh > 0) {
					newh = VIVIZ[galleryid]["fullNaturalHeight"]-dh-dw/ar;
				} else {
					newh = VIVIZ[galleryid]["fullNaturalHeight"]-dw/ar;
				}
				newh = newh - 1;
				console.log("gallery.settabledims(): Shrinking height of #fullframe img again because of overlap in width.  New height: "+newh)
				$(wrapper + ' #fullframe img').height(newh)
				console.log("gallery.settabledims(): Shrinking height of #gallerythumbframe again because of overlap in width.  New height: "+newh);
				$(wrapper + ' #gallerythumbframe').height(newh);
				VIVIZ[galleryid]['fullHeight'] = newh;
				//VIVIZ[galleryid]['fullWidth']  = newh*ar;      		        	
	 			VIVIZ[galleryid]['fullWidth'] = $(wrapper + ' #fullframe img:first').width();
			} 


			dh = $(enclosure).height() - $(window).height();
			if (dh < 0) {
				console.log("gallery.settabledims(): Setting top margin for " + wrapper);
				$(wrapper).css('margin-top',-dh/2);
			}	
		} else {
			console.log("gallery.settabledims(): Full image height unknown but thumb height known.");
			var a = 4*VIVIZ[galleryid]["thumbHeight"];
			console.log("gallery.settabledims(): Setting thumb frame height to be 4*(first thumb outer height) = "+a);
			console.log("gallery.settabledims(): First thumbnail height = " + $('#gallerythumbframe img').eq(0).height());
			$(wrapper + ' #gallerythumbframe').height("" + a);
		}

		if (callback) {
			callback();
		}
	}
	
	function loadfull(jq) {

		console.log("gallery.loadfull(): Called.");

		var id = $(jq).attr('id');
		var lastvisible = parseInt($(wrapper).attr('lastvisible'));
		$(wrapper + " #fullframe img[id=" + lastvisible + "]").hide();
		//$(wrapper + " #fullframe img[id=" + lastvisible + "]").css('visibility','hidden');
		
		if (id > INFOjs.length) {return;}
		
		if ($(wrapper + " #fullframe img[id="+id+"]").length == 1) {
			console.log('gallery.loadfull(): Found hidden full image in DOM.  Showing.');
			$(wrapper + " #fullframe img[id=" + id + "]").show();
			prepnext();
			setfilename(id);
			return;
		}

		// Show loading indicator
		$(wrapper + ' #workingfullframe').css('visibility','visible');

		// Place empty image element in DOM.
		$(wrapper + " #fullframe").prepend('<img id="'+id+'" class="full"/>');

		// Does not work.
		//var title = $(jq).attr("title"); 
		//$(wrapper + " #fullframe img[id="+id+"]").attr("title",title)
		
		$(wrapper + " #fullframe img[id="+id+"]")
				.unbind('load')
				.error(function () {
					$(wrapper + ' #workingfullframe').css('visibility','hidden');
					//$(wrapper + ' #error').html('Could not load <a href="'+$(this).attr('src')+'">'+$(this).attr('src')+'</a>')
					console.log("Error loading ")
					$(this).width(VIVIZ[galleryid]["fullWidth"]);
					$(this).height(VIVIZ[galleryid]["fullHeight"]);
				})
				.load(function(){

					console.log("gallery.loadfull(): Load event.")

					// Hide loading indicator
					$(wrapper + ' #workingfullframe').css('visibility','hidden');

					if ($(jq).hasClass('firstimage')) {
						console.log('gallery.loadfull(): First full image loaded with dimensions '+this.naturalWidth+'x'+this.naturalHeight+'.  Setting table dimensions.');


						//Enlil code
						if (VIVIZ["alternativeFrame"]) {
							$("#" + VIVIZ["alternativeFrame"] + " img").attr('src',$(wrapper + " #fullframe img[id=1]").attr('src'))
						}

						el = this;
						type = 'full';
						var ar = el.naturalWidth/el.naturalHeight;

						// Compute pixels if given fractions.
						if (VIVIZ[type+"Width"]) {
							if (VIVIZ[type+"Width"] > 1.0) {
								VIVIZ[galleryid][type+"Width"] = VIVIZ[type+"Width"];
							} else {
								VIVIZ[galleryid][type+"Width"] = el.naturalWidth*VIVIZ[type+"Width"];
							}
						}
						if (VIVIZ[type+"Height"]) {
							if (VIVIZ[type+"Height"] > 1.0) {
								VIVIZ[galleryid][type+"Height"] = VIVIZ[type+"Height"];
							} else {
								VIVIZ[galleryid][type+"Height"] = el.naturalHeight*VIVIZ[type+"Height"];
							}
						}

						// Compute un-specified width or height.
						if (VIVIZ[galleryid][type+"Width"] && !VIVIZ[galleryid][type+"Height"]) {
							VIVIZ[galleryid][type+"Height"] = VIVIZ[galleryid][type+"Width"]/ar;
						}
						if (VIVIZ[galleryid][type+"Height"] && !VIVIZ[galleryid][type+"Width"]) {
							VIVIZ[galleryid][type+"Width"] = VIVIZ[galleryid][type+"Height"]*ar;
						}

						if (!VIVIZ[galleryid][type+"Height"]) {
							VIVIZ[galleryid][type+"Height"] = el.naturalHeight;
						}
						if (!VIVIZ[galleryid][type+"Width"]) {
							VIVIZ[galleryid][type+"Width"] = el.naturalWidth;
						}

						VIVIZ[galleryid][type+"NaturalHeight"] = el.naturalHeight;
						VIVIZ[galleryid][type+"NaturalWidth"] = el.naturalWidth;

						// Set height of full image.
						$(this).css("height",VIVIZ[galleryid]["fullHeight"]);
						//$(this).css("width",VIVIZ[galleryid]["fullWidth"]);

						var enclosure = "body"
						console.log("gallery.loadfull(): Window height: "+ $(window).height());
						console.log("gallery.loadfull(): Document height: "+ $(document).height());
						console.log("gallery.loadfull(): Enclosing body height: " + $(enclosure).height());
						
						// After this function sets VIVIZ[gallerid] dimensions, then call prepnext(), which uses
						// these dimensions.
						settabledims(this, function () {prepnext()});

					} else {
						prepnext();
					}

					setfilename($(this).attr('id'));

				})
				.attr('src', INFOjs[parseInt(id-1)]["FullFile"]);

		function setfilename(id) {
			var fname = INFOjs[parseInt(id-1)]["FullFile"]
			$(wrapper + " #filename").html('');
			var wo = $(wrapper + " #catalog").width()
			console.log("#catalog div width "+wo)

			$(wrapper + " #filename").append("<a>");
			$(wrapper + " #filename a")
				.attr('href',INFOjs[parseInt(id-1)]["FullFile"])
				.text(INFOjs[parseInt(id-1)]["FullFile"]);
			var wx = $(wrapper + " #filename").width();
			console.log("#filename div width "+wx)
			if (wo < wx) {
				// Fraction to remove. 0.9 to account for nonuniformity of charater width.
				r = 0.9*wo/wx
				console.log("Reduction factor: " + r)
				l = fname.length
				nr = l-r*l
				console.log("Number of characters to remove:  "+nr)
				c = l/2
				console.log("Center value: " + c)
				console.log("Number of characters to keep : " + nr)
				fnamer = fname.substr(0,Math.floor(c-nr/2)) + "..." + fname.substr(Math.ceil(c+nr/2),l)
				$(wrapper + " #filename a")
					.attr('href',INFOjs[parseInt(id-1)]["FullFile"])
					.text(fnamer);

			}

		}

		function prepnext() {
			
			// If next frame not in DOM, place it.
			var idn = parseInt(id) + 1;
			
			if (idn > INFOjs.length) {return;}

			if ($(wrapper + " #fullframe img[id="+idn+"]").length == 0) {
				$(wrapper + " #fullframe").prepend('<img id="'+idn+'" class="full" style="display:none"/>');
				$(wrapper + " #fullframe img[id="+idn+"]")
					.error(function () {
						$(wrapper + ' #workingfullframe').css('visibility','hidden');
						$(this).height(VIVIZ[galleryid]["fullHeight"]);
						$(this).width(VIVIZ[galleryid]["fullWidth"]);
					})
					.load (function () {
					})
					.css('height',VIVIZ[galleryid]['fullHeight'])
					.attr('src',INFOjs[idn-1]["FullFile"])
			}
		}
	}

	function loadmore() {

		var length = parseInt($('#gallerythumbframe').attr('data-thumb-length'));
		var shown = parseInt($("#gallerythumbframe > img").last().attr("id"));
		if (shown < length) {
			var maxLength = length;
			if (length > (shown+VIVIZ["lazyLoadMax"]))
				maxLength = shown+VIVIZ["lazyLoadMax"];
			
			//$(wrapper).attr('totalvisible', maxLength);
			//elem.attr('data-thumb-displayed', maxLength);
			//console.log(shown)
			var tic = new Date().getTime();
			var slowwarn = false;
			for (j=shown; j < shown+maxLength; j++) {
				//console.log("j="+j)
				if (j > INFOjs.length-1) break;
				$('<img class="gallerythumbbrowse lazyload"/>')
					.appendTo($(wrapper + ' #gallerythumbframe'))
					.attr("id",j+1)
					.attr("src", INFOjs[j].ThumbFile)
					.bind('click',setthumbbindings)
					.attr("title",imgtitle(INFOjs[j]))
					//.css("height",thumbheight)
					.css("height",$("#gallerythumbframe > img").first().height())
					.css("width",$("#gallerythumbframe > img").first().width())
					//.error(function () {$(this).remove())
					.load(function () {
						//$(wrapper).attr('totalvisible', parseInt($(wrapper).attr('totalvisible'))+1);
						if ((slowwarn == false) && (new Date().getTime() - tic > 3000)) {
							warning(wrapper,"Slow-loading gallery.  See <a href='http://viviz.org/#Performace'>performace tips</a> for improving performance.",true);
							slowwarn = true;	
							setTimeout(function () {$('#connectionerror').html('')},5000);
						}

						// The following will sometimes hide spinner before thumbnails are rendered on screen, because load
						// is triggered when image has been downloaded and before it is rendered.  This is the reason
						// for the 2*Nthumb ms delay (a guess).
						////console.log('Thumb '+parseInt($(this).attr('id'))+' loaded.');
														
					});
			}
		}
	}
	
	function setthumbbindings() {

		// Actions to take when a thumbnail is clicked.
		
		console.log("gallery.setthumbbindings(): Called.")

		var nowvisible  = parseInt($(wrapper).attr('nowvisible'));
		if (isNaN(nowvisible)) {
			nowvisible = 1;
			$(wrapper).attr('nowvisible', '1');
		} else {
			nowvisible = $(this).attr('id');
			//console.log('Setting nowvisible to ' + nowvisible);
			$(wrapper).attr('nowvisible', nowvisible);
		}
		var lastvisible = parseInt($(wrapper).attr('lastvisible'));
		if (isNaN(lastvisible)) {
			lastvisible = 1;
			$(wrapper).attr('lastvisible', '1');
		}
		
		$(wrapper + " #gallerythumbframe #" + lastvisible).removeClass('active').addClass('inactive');

		$(wrapper + " #gallerythumbframe #" + nowvisible).removeClass('inactive').addClass('active');
		
		// TODO: Duplicate calls can be avoided by giving each stat string an id and then showing hidden
		// 		 stat string if it already exists in DOM.
		INFOjs = thumblist(wrapper); 

		var statstr = "#" + (nowvisible) + "/" + (INFOjs.length) + " in subset.  Image attributes ";
		statstr = statstr + " | #" + (1+INFOjs[nowvisible-1].ImageNumber) + "/" + $(wrapper).attr('totalingallery') + " in gallery | ";
		
		for (var z = 1;z < GALLERYINFO['attributes']["Values"].length;z++) {
			statstr = statstr + GALLERYINFO['attributes']["Values"][z].Title + " = ";
			if (GALLERYINFO['attributes']["Values"][z].Format) {
				statstr = statstr + sprintf(GALLERYINFO['attributes']["Values"][z].Format,parseFloat(INFOjs[nowvisible-1][GALLERYINFO['attributes']["Values"][z].Value]));
			} else {
				statstr = statstr + INFOjs[nowvisible-1][GALLERYINFO['attributes']["Values"][z].Value];            		
			}
			if (GALLERYINFO['attributes']["Values"][z].Unit) {
				statstr = statstr + " [" + GALLERYINFO['attributes']["Values"][z].Unit + "] " +  " | ";
			} else {
				statstr = statstr + " | ";
			}
		}

		$(wrapper + ' #stats').html(statstr);

		// Load full image.
		loadfull(this); 
		
		$(wrapper).attr("lastvisible",nowvisible);

		// Scroll thumbnail list
		$(wrapper + " #gallerythumbframe").scrollTo(this, 0, {
		   duration: 80, offset: 0
		});
	}

	function imgtitle(obj) {
		//http://stackoverflow.com/questions/5612787/converting-javascript-object-to-string
		var str = '';
		var k = 0;
		for (var p in obj) {
			if (obj.hasOwnProperty(p)) {
				if (isNaN(parseInt(p)))
					str += p + ':' + obj[p] + '\n';
				}
				k = k+1;
			}
			return str;
	}
	
	function setcontrolbindings() {
		
		// Show/Hide thumb button
		$(wrapper + " #showhidethumb").unbind('toggle');
		$(wrapper + " #showhidethumb").toggle(function(){
				$(wrapper + " #gallerythumbframe").hide();
				//$(wrapper + " #gallerythumbframe").css('visibility','hidden');
				//$(wrapper + " #gallerythumbframe").css('width','0px');
				setcontrolbindings.marginleft = $("#fullframe").css('margin-left');
				$("#fullframe").css('margin-left','0');
				$(wrapper + ' #showhidethumb').text('+');
				$(wrapper + ' #showhidethumb').attr('title','Show thumbnails')
			}, function(){
				console.log("gallery.setcontrolbindings: Showing gallerythumbframe.");
				$(wrapper + " #gallerythumbframe").css('visibility','visible')
				$(wrapper + " #gallerythumbframe").show();
				console.log("gallery.setcontrolbindings: Setting margin-left to " + setcontrolbindings.marginleft);
				$("#fullframe").css('margin-left',setcontrolbindings.marginleft)
				$(wrapper + ' #showhidethumb').text('x');
				$(wrapper + ' #showhidethumb').attr('title','Hide thumbnails')
		});

		if (!VIVIZ["showThumbstrip"]) {$("#showhidethumb").click();}
		
		var si = false;
		$(wrapper + " #stop").unbind('click');
		$(wrapper + " #stop").click(
				function () {
					if (typeof(si) === "number") {
						clearInterval(si);
					}
				}
		)

		$(wrapper + " #play").unbind('click');
		$(wrapper + " #play").click(
				function () {
					$("#next").click();
					si = setInterval(
							function () {
								$("#next").click();
							},VIVIZ["frameRate"]);
				}
				
		)

		// Time step buttons
		$(wrapper + " #next").unbind('click');
		$(wrapper + ' #next').click(function(){
			lastvisible = parseInt($(wrapper).attr('lastvisible'));
			if (lastvisible == parseInt($(wrapper).attr('totalvisible'))) {				
				nowvisible = parseInt($(wrapper + " #gallerythumbframe img.firstimage").attr('id'));
			} else {
				nowvisible = lastvisible + 1;        	
			}
			console.log("gallery.setcontrolbindings: Next button clicked.  Clicking on thumbnail "+nowvisible)
			$(wrapper + " #gallerythumbframe #" + nowvisible).click();

			//Enlil code
			if (VIVIZ["alternativeFrame"]) {
				$("#" + VIVIZ["alternativeFrame"] + " img").attr('src',$(wrapper + " #fullframe img[id="+nowvisible+"]").attr('src'));
			}

			var length = parseInt($('#gallerythumbframe').attr('data-thumb-length'));
			var shown = parseInt($("#gallerythumbframe > img").last().attr("id"));
			var f = Math.ceil(nowvisible/VIVIZ["lazyLoadMax"]) - nowvisible/VIVIZ["lazyLoadMax"];
			if (f < 0.5) loadmore();
		});
		
		$(wrapper + " #previous").unbind('click');
		$(wrapper + ' #previous').click(function(){
			lastvisible = parseInt($(wrapper).attr('lastvisible'));
			if (lastvisible == 1) {
				nowvisible = parseInt($(wrapper).attr('totalvisible'));
			} else {
				nowvisible = lastvisible - 1;
			}
			$(wrapper + " #" + nowvisible).click();

			//Enlil code
			if (VIVIZ["alternativeFrame"]) {
				$("#" + VIVIZ["alternativeFrame"] + " img").attr('src',$(wrapper + " #fullframe img[id="+nowvisible+"]").attr('src'))
			}

		});
		
		$(wrapper + " #last").unbind('click');
		$(wrapper + ' #last').click(function(){
			nowvisible = parseInt($(wrapper + " #gallerythumbframe > img").last().attr("id"));
			$(wrapper + " #" + nowvisible).click();
		});

		$(wrapper + " #first").unbind('click');    
		$(wrapper + ' #first').click(function(){
			nowvisible = parseInt($(wrapper + " #gallerythumbframe > img").first().attr("id"));
			$(wrapper + " #" + nowvisible).click();
		});  
	}
	
	function setdropdowns() {
		$(wrapper + " #dropdownswrapper").empty();
		dropdown("gallery", GALLERIES, wrapper + " #dropdownswrapper");
		$(wrapper + " #gallery option[value='" + galleryid + "']").attr('selected','selected');
		
		$(wrapper + ' #dropdownswrapper #gallery').unbind('change');
		$(wrapper + ' #dropdownswrapper #gallery').change(function (){
			console.log('gallery.js: Gallery changed.  galleryid = ' + galleryid);
			var galleryid = $(wrapper + " #gallery option:selected").val();
			$(wrapper + " #error").html("");
			console.log("gallery.js: Setting hash.")
			location.hash = "/" + galleryid;
		});

		// Does not work anymore with lazy load.
		dropdown("order", GALLERYINFO['orders'], wrapper + " #dropdownswrapper");

		//console.log(GALLERYINFO);
		//dropdown("output", GALLERYINFO['outputs'], wrapper + " #dropdowns");
		

		$(wrapper + ' #dropdownswrapper #order').change(function(){
			setthumbs();
		});
		$(wrapper + ' #dropdowns #download').change(function(){
			console.log("---- Download option not implemented.");
			// TODO: If imgconvert link works and VIVIZ["showDownloads"] is true, show this.
			// If imgconvert link does not work, make download drop-down text red and change tool tip to indicate problem.
		});

		if (GALLERYINFO['attributes']["Values"].length > 0) {
			dropdown("sortby", GALLERYINFO['attributes'], wrapper + " #dropdownswrapper");
			$(wrapper + ' #dropdownswrapper #sortby').change(function(){
				setregexps();
				setthumbs();
			});
			setregexps();	
		} else {
			console.log("gallery.setdropdowns(): No sort attributes.  Not displaying drop-downs for attributes.")
		}

		return true;

		function setregexps() {
			var REGEXPS            = new Object();			
			var n                  = $(wrapper + " #dropdownswrapper #sortby option:selected").val();
			REGEXPS["Title"]       = "View only images with an attribute that matches the selected constraint."
			REGEXPS["Titleshort"]  = "-Constraints-"
			REGEXPS["Values"]      = new Array();
			////console.log(GALLERYINFO['attributes'])
			for (i = 0; i < GALLERYINFO['attributes']["Values"][n]["Filters"].length; i++) {
				REGEXPS["Values"][i]          = new Object();
				REGEXPS["Values"][i]["Title"] = GALLERYINFO['attributes']["Values"][n]["Filters"][i]["Title"];
				REGEXPS["Values"][i]["Value"] = GALLERYINFO['attributes']["Values"][n]["Filters"][i]["Value"];
			}

			if (GALLERYINFO['attributes']["Values"][n]["Filters"].length > 1) {
				dropdown("regexp",REGEXPS,wrapper + " #dropdownswrapper");
			} else {
				console.log("gallery.setdropdowns(): No regexp filters.  Not displaying drop-down.")
				//$("#thumb1 #dropdownswrapper #regexp").remove();				
			}

			$(wrapper + ' #dropdownswrapper #regexp').change(function(){
				$(wrapper + " #fullframe").empty();
				setthumbs();
			})
		}
	}

}
